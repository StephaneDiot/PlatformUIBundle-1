/*
 * Copyright (C) eZ Systems AS. All rights reserved.
 * For full copyright and license information view LICENSE file distributed with this source code.
 */
YUI.add('ez-date-editview', function (Y) {
    "use strict";
    /**
     * Provides the field edit view for the date fields
     *
     * @module ez-date-editview
     */

    Y.namespace('eZ');

    var FIELDTYPE_IDENTIFIER = 'ezdate';

    /**
     * Date edit view
     *
     * @namespace eZ
     * @class dateEditView
     * @constructor
     * @extends eZ.FieldEditView
     */
    Y.eZ.DateEditView = Y.Base.create('dateEditView', Y.eZ.FieldEditView, [], {
        events: {
            '.ez-date-input-ui input': {
                'blur': 'validate',
                'valuechange': 'validate',

            }
        },

        /**
         * Validates the current input of date field
         *
         * @method validate
         */
        validate: function () {
            var validity = this._getInputValidity();
            console.log(this.get('field'));
            console.log(this.get('container').one('.ez-date-input-ui').get('value'));
            if ( validity.valueMissing ) {
                this.set('errorStatus', 'This field is required');
            } else {
                this.set('errorStatus', false);
            }
            if ( validity.badInput ) {
                this.set('errorStatus', 'This is not a valid input');
            } else {
                this.set('errorStatus', false);
            }
        },

        /**
         * Defines the variables to imported in the field edit template for date
         *
         * @protected
         * @method _variables
         * @return {Object} containing isRequired
         */
        _variables: function () {
            var def = this.get('fieldDefinition'),
                date;
            if (this.get('field').fieldValue && this.get('field') && this.get('field').fieldValue.timestamp) {
                date = Y.Date.format(new Date(this.get('field').fieldValue.timestamp * 1000));
            } else {
                date = new Date();
            }
            return {
                "isRequired": def.isRequired,
                "html5InputDate": date
            };
        },

        /**
         * Returns the input validity state object for the input generated by
         * the date template
         *
         * See https://developer.mozilla.org/en-US/docs/Web/API/ValidityState
         *
         * @protected
         * @method _getInputValidity
         * @return {ValidityState}
         */
        _getInputValidity: function () {
            return this.get('container').one('.ez-date-input-ui input').get('validity');
        },

        /**
         * Returns the currently filled date value
         *
         * @protected
         * @method _getFieldValue
         * @return {Object}
         */
        _getFieldValue: function () {
            var valueOfInput;

            if(this.get('container').one('.ez-date-input-ui input').get('value')) {
                valueOfInput = (new Date(
                    this.get('container').one('.ez-date-input-ui input').get('value')).getTime())/1000;
                return {timestamp: valueOfInput};
            }
            return null;
        },

    });

    Y.eZ.FieldEditView.registerFieldEditView(
        FIELDTYPE_IDENTIFIER, Y.eZ.DateEditView
    );
});
